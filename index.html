import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged,
  signInWithCustomToken 
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  updateDoc, 
  deleteDoc, 
  doc, 
  query, 
  onSnapshot,
  serverTimestamp 
} from 'firebase/firestore';
import { 
  Plus, DollarSign, User, AlertCircle, FileText, 
  Trash2, X, ArrowLeft, Printer, Lock, Calculator, Settings, PieChart, CheckCircle, TrendingUp, Briefcase
} from 'lucide-react';

// --- Configuración de Firebase ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

const App = () => {
  const [user, setUser] = useState(null);
  const [loans, setLoans] = useState([]);
  const [loading, setLoading] = useState(true);
  const [view, setView] = useState('dashboard'); 
  const [selectedLoan, setSelectedLoan] = useState(null);
  const [showReceipt, setShowReceipt] = useState(null);
  const [deletePinInput, setDeletePinInput] = useState('');
  const [itemToDelete, setItemToDelete] = useState(null); 
  const [notification, setNotification] = useState(null); 

  // 1. Autenticación
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Auth error:", error);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // 2. Sincronización de Datos
  useEffect(() => {
    if (!user) return;
    const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'loans'));
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const loansData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      loansData.sort((a, b) => b.createdAt?.seconds - a.createdAt?.seconds);
      setLoans(loansData);
      setLoading(false);
      // Actualizar detalle en tiempo real
      if (selectedLoan) {
        const updated = loansData.find(l => l.id === selectedLoan.id);
        if (updated) setSelectedLoan(updated);
      }
    });
    return () => unsubscribe();
  }, [user, selectedLoan?.id]);

  const showNotification = (msg) => {
    setNotification(msg);
    setTimeout(() => setNotification(null), 3000);
  };

  // --- Lógica Principal ---

  const handleCreateLoan = async (loanData) => {
    if (!user) return;
    
    const newLoan = {
      clientName: loanData.clientName,
      amount: loanData.principal,
      quotaAmount: loanData.quotaAmount,
      quotaCount: loanData.quotaCount,
      frequency: loanData.frequency,
      totalToPay: loanData.totalToPay,
      originalProfit: loanData.profit,
      balance: loanData.totalToPay,
      status: 'Activo',
      createdAt: serverTimestamp(),
      dateString: new Date().toLocaleDateString(),
      history: [] 
    };

    try {
      await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'loans'), newLoan);
      showNotification("¡Préstamo Guardado Exitosamente!");
      setView('dashboard');
    } catch (e) {
      console.error("Error creating:", e);
    }
  };

  const handleTransaction = async (loanId, type, amountVal, note) => {
    if (!user) return;
    const loan = loans.find(l => l.id === loanId);
    if (!loan) return;

    const amount = parseFloat(amountVal);
    let newBalance = loan.balance;
    
    if (type === 'payment') newBalance = Math.max(0, loan.balance - amount);
    if (type === 'penalty') newBalance = loan.balance + amount;

    const newStatus = newBalance <= 1 ? 'Pagado' : 'Activo';
    
    const newTransaction = {
      id: Date.now().toString(),
      type, amount, note: note || (type === 'payment' ? 'Abono' : 'Mora'),
      date: new Date().toLocaleString(),
      balanceAfter: newBalance
    };

    try {
      await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'loans', loanId), {
        balance: newBalance,
        status: newStatus,
        history: [newTransaction, ...(loan.history || [])]
      });
      
      if (type === 'payment') {
        setShowReceipt({ loan: { ...loan, balance: newBalance }, transaction: newTransaction });
      }
    } catch (e) { console.error(e); }
  };

  const verifyAndDelete = async () => {
    if (deletePinInput !== '203031') {
      alert("PIN INCORRECTO"); 
      return;
    }
    if (user && itemToDelete) {
      await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'loans', itemToDelete.id));
      setView('dashboard');
      setSelectedLoan(null);
      showNotification("Registro eliminado correctamente");
    }
    setItemToDelete(null);
    setDeletePinInput('');
  };

  // --- Pantallas ---

  const Dashboard = () => {
    const active = loans.filter(l => l.status === 'Activo');
    const totalCalle = active.reduce((acc, curr) => acc + curr.balance, 0);
    const ganancia = loans.reduce((acc, curr) => acc + (curr.originalProfit || 0), 0);

    return (
      <div className="animate-fade-in space-y-6">
        <header className="flex justify-between items-center px-1">
          <div>
            <h1 className="text-2xl font-black text-gray-800 tracking-tight">Prestamos<span className="text-blue-600">Pro</span></h1>
            <p className="text-xs text-gray-400 font-medium">Panel de Control</p>
          </div>
          <button onClick={() => setView('create')} className="bg-blue-600 text-white p-3 rounded-xl shadow-lg shadow-blue-200 hover:bg-blue-700 active:scale-95 transition-all flex items-center gap-2">
            <Plus size={20} strokeWidth={3}/> <span className="font-bold hidden sm:inline">Nuevo</span>
          </button>
        </header>

        {/* Stats */}
        <div className="grid grid-cols-2 gap-4">
          <div className="bg-white p-5 rounded-3xl shadow-sm border border-gray-100 flex flex-col justify-between h-32">
            <div className="flex justify-between items-start">
               <div className="p-2 bg-blue-50 text-blue-600 rounded-lg"><DollarSign size={20}/></div>
               <span className="text-[10px] bg-gray-100 px-2 py-1 rounded text-gray-500 font-bold">HOY</span>
            </div>
            <div>
              <p className="text-gray-400 text-xs font-bold uppercase mb-1">Por Cobrar</p>
              <p className="text-2xl font-black text-gray-800">${totalCalle.toLocaleString()}</p>
            </div>
          </div>
          <div className="bg-gray-900 p-5 rounded-3xl shadow-lg flex flex-col justify-between h-32 text-white relative overflow-hidden">
            <div className="absolute right-0 top-0 opacity-10 p-4"><TrendingUp size={80}/></div>
            <div className="flex justify-between items-start relative z-10">
               <div className="p-2 bg-gray-700 rounded-lg"><PieChart size={20}/></div>
            </div>
            <div className="relative z-10">
              <p className="text-gray-400 text-xs font-bold uppercase mb-1">Ganancia Total</p>
              <p className="text-2xl font-black text-green-400">+${ganancia.toLocaleString()}</p>
            </div>
          </div>
        </div>

        {/* Lista */}
        <div>
          <h2 className="text-lg font-bold text-gray-700 mb-4 px-1">Cartera de Clientes</h2>
          {active.length === 0 ? (
            <div className="text-center py-16 bg-white rounded-3xl border border-dashed border-gray-200">
              <div className="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-3">
                <User className="text-gray-300" size={30}/>
              </div>
              <p className="text-gray-400 font-medium">No hay préstamos activos</p>
            </div>
          ) : (
            <div className="space-y-3 pb-20">
              {active.map(loan => (
                <div key={loan.id} onClick={() => {setSelectedLoan(loan); setView('detail')}} 
                  className="bg-white p-5 rounded-2xl shadow-sm border border-gray-50 hover:shadow-md transition active:scale-[0.98] cursor-pointer group">
                  <div className="flex justify-between items-start mb-3">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center font-bold text-lg">
                        {loan.clientName.charAt(0).toUpperCase()}
                      </div>
                      <div>
                        <h3 className="font-bold text-gray-800 text-lg leading-tight">{loan.clientName}</h3>
                        <p className="text-xs text-gray-400">{loan.frequency}</p>
                      </div>
                    </div>
                    <div className="text-right">
                      <p className="font-bold text-blue-600 text-lg">${loan.balance.toLocaleString()}</p>
                      <p className="text-[10px] text-gray-400 uppercase font-bold tracking-wide">Pendiente</p>
                    </div>
                  </div>
                  <div className="w-full bg-gray-100 rounded-full h-2 overflow-hidden">
                    <div className="bg-blue-500 h-full rounded-full" style={{width: `${((loan.totalToPay - loan.balance)/loan.totalToPay)*100}%`}}></div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    );
  };

  const CreateLoan = () => {
    const [form, setForm] = useState({
      clientName: '',
      principal: '',
      paymentCapacity: '',
      interestRate: 20,
      frequency: 'Quincenal'
    });

    const calc = useMemo(() => {
      const capital = parseFloat(form.principal) || 0;
      const rate = parseFloat(form.interestRate) || 0;
      const payCap = parseFloat(form.paymentCapacity) || 0;
      
      if (capital <= 0 || payCap <= 0) return null;

      const totalDebt = capital + (capital * (rate / 100));
      const profit = totalDebt - capital;
      const count = Math.ceil(totalDebt / payCap);

      return { totalToPay: totalDebt, profit, quotaCount: count, isValid: true };
    }, [form]);

    return (
      <div className="animate-slide-up">
        <div className="flex items-center mb-6 px-1">
          <button onClick={() => setView('dashboard')} className="p-2 mr-2 bg-white shadow-sm border border-gray-100 rounded-xl text-gray-600"><ArrowLeft size={20}/></button>
          <h1 className="text-xl font-bold text-gray-800">Nuevo Préstamo</h1>
        </div>

        <div className="space-y-6">
          <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
             <label className="text-xs font-bold text-gray-400 uppercase tracking-wide mb-2 block">Nombre del Cliente</label>
             <input type="text" placeholder="Ej. Maria Perez" autoFocus
               className="w-full text-lg font-bold text-gray-800 placeholder-gray-300 outline-none border-b border-gray-100 pb-2 focus:border-blue-500 transition-colors"
               value={form.clientName} onChange={e => setForm({...form, clientName: e.target.value})}
             />
          </div>

          <div className="grid grid-cols-2 gap-4">
             <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
               <label className="text-xs font-bold text-blue-600 uppercase tracking-wide mb-2 block">Monto a Dar</label>
               <div className="flex items-center">
                 <span className="text-gray-300 text-xl font-bold mr-1">$</span>
                 <input type="number" placeholder="0"
                   className="w-full text-2xl font-black text-gray-800 outline-none placeholder-gray-200"
                   value={form.principal} onChange={e => setForm({...form, principal: e.target.value})}
                 />
               </div>
             </div>
             <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
               <label className="text-xs font-bold text-green-600 uppercase tracking-wide mb-2 block">Pago {form.frequency}</label>
               <div className="flex items-center">
                 <span className="text-gray-300 text-xl font-bold mr-1">$</span>
                 <input type="number" placeholder="0"
                   className="w-full text-2xl font-black text-gray-800 outline-none placeholder-gray-200"
                   value={form.paymentCapacity} onChange={e => setForm({...form, paymentCapacity: e.target.value})}
                 />
               </div>
             </div>
          </div>

          <div className="flex gap-4 overflow-x-auto pb-2">
            <div className="bg-gray-50 px-4 py-3 rounded-xl flex items-center gap-3 border border-gray-200 min-w-max">
               <Settings size={16} className="text-gray-400"/>
               <div>
                  <label className="text-[10px] uppercase font-bold text-gray-400 block">Interés</label>
                  <input type="number" value={form.interestRate} onChange={e => setForm({...form, interestRate: e.target.value})}
                    className="bg-transparent font-bold text-gray-700 w-12 outline-none"/>
                  <span className="text-gray-500 font-bold">%</span>
               </div>
            </div>
            <div className="bg-gray-50 px-4 py-3 rounded-xl flex items-center gap-3 border border-gray-200 min-w-max">
               <Calculator size={16} className="text-gray-400"/>
               <div>
                  <label className="text-[10px] uppercase font-bold text-gray-400 block">Frecuencia</label>
                  <select value={form.frequency} onChange={e => setForm({...form, frequency: e.target.value})}
                    className="bg-transparent font-bold text-gray-700 outline-none text-sm">
                    <option>Semanal</option><option>Quincenal</option><option>Mensual</option>
                  </select>
               </div>
            </div>
          </div>

          {calc && form.clientName && (
            <div className="bg-gray-900 rounded-3xl p-6 text-white shadow-xl animate-scale-up relative overflow-hidden">
              <div className="absolute top-0 right-0 p-8 opacity-5"><DollarSign size={150}/></div>
              <div className="relative z-10">
                <div className="flex justify-between items-end mb-6 border-b border-gray-700 pb-6">
                   <div>
                      <p className="text-gray-400 text-xs font-bold uppercase mb-1">Total a Cobrar</p>
                      <p className="text-4xl font-black tracking-tight">${calc.totalToPay.toLocaleString()}</p>
                   </div>
                   <div className="text-right">
                      <p className="text-gray-400 text-xs font-bold uppercase mb-1">Ganancia</p>
                      <p className="text-xl font-bold text-green-400">+${calc.profit.toLocaleString()}</p>
                   </div>
                </div>
                <div className="flex items-center gap-3 text-sm text-gray-300">
                   <div className="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center font-bold text-white shadow-lg shadow-blue-900/50">
                     {calc.quotaCount}
                   </div>
                   <p>Pagos estimados para liquidar</p>
                </div>
              </div>
            </div>
          )}

          <button 
            disabled={!calc || !form.clientName}
            onClick={() => handleCreateLoan({...form, ...calc, quotaAmount: form.paymentCapacity})}
            className={`w-full py-4 rounded-2xl font-bold text-lg shadow-lg transition-all transform active:scale-95 ${
              calc && form.clientName ? 'bg-blue-600 text-white hover:bg-blue-700 hover:shadow-blue-200' : 'bg-gray-200 text-gray-400 cursor-not-allowed'
            }`}
          >
            Guardar Préstamo
          </button>
        </div>
      </div>
    );
  };

  const LoanDetail = () => {
    if (!selectedLoan) return null;
    const [action, setAction] = useState(null); 
    const [val, setVal] = useState('');
    const [note, setNote] = useState('');

    const progress = Math.min(100, ((selectedLoan.totalToPay - selectedLoan.balance)/selectedLoan.totalToPay)*100);

    const submitAction = (e) => {
      e.preventDefault();
      if(!val) return;
      handleTransaction(selectedLoan.id, action, val, note);
      setAction(null); setVal(''); setNote('');
    };

    return (
      <div className="animate-slide-up pb-10">
        <div className="sticky top-0 bg-gray-100 z-20 py-2 flex justify-between items-center mb-2 px-1">
           <button onClick={() => {setSelectedLoan(null); setView('dashboard')}} className="p-2 bg-white shadow-sm border border-gray-200 rounded-xl text-gray-600 flex items-center gap-2 font-bold text-sm"><ArrowLeft size={16}/> Volver</button>
           <button onClick={() => setItemToDelete({type: 'loan', id: selectedLoan.id})} className="p-2 bg-white text-red-400 hover:bg-red-50 border border-gray-200 rounded-xl"><Trash2 size={20}/></button>
        </div>

        {/* Tarjeta de Estado Principal */}
        <div className="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 mb-4 relative overflow-hidden">
           <div className="flex justify-between items-start mb-6">
             <div>
                <h2 className="text-3xl font-black text-gray-800 leading-none mb-2">{selectedLoan.clientName}</h2>
                <span className="bg-blue-50 text-blue-600 px-3 py-1 rounded-lg text-xs font-bold uppercase tracking-wide">{selectedLoan.frequency}</span>
             </div>
             <div className="text-right">
                <p className="text-xs text-gray-400 font-bold uppercase">Deuda Total</p>
                <p className="text-xl font-bold text-gray-400 decoration-gray-300">${selectedLoan.totalToPay.toLocaleString()}</p>
             </div>
           </div>
           
           <div className="flex justify-between items-end mb-3">
              <div>
                <p className="text-xs text-gray-400 uppercase font-bold mb-1">Pendiente de Pago</p>
                <p className="text-5xl font-black text-blue-600 tracking-tight">${selectedLoan.balance.toLocaleString()}</p>
              </div>
           </div>
           <div className="w-full bg-gray-100 h-3 rounded-full overflow-hidden">
              <div className="bg-blue-500 h-full transition-all duration-1000 ease-out" style={{width: `${progress}%`}}></div>
           </div>
           <p className="text-right text-[10px] text-gray-400 font-bold mt-2 uppercase">{Math.round(progress)}% Completado</p>
        </div>

        {/* --- NUEVA SECCIÓN: INFORMACIÓN DE NEGOCIO --- */}
        <div className="grid grid-cols-2 gap-4 mb-6">
           <div className="bg-gray-50 p-4 rounded-2xl border border-gray-200 flex flex-col justify-center items-center text-center">
              <div className="p-2 bg-white rounded-full text-gray-400 mb-2 shadow-sm"><Briefcase size={18}/></div>
              <p className="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Monto Prestado</p>
              <p className="text-lg font-black text-gray-700">${selectedLoan.amount.toLocaleString()}</p>
           </div>
           <div className="bg-green-50 p-4 rounded-2xl border border-green-100 flex flex-col justify-center items-center text-center">
              <div className="p-2 bg-white rounded-full text-green-500 mb-2 shadow-sm"><TrendingUp size={18}/></div>
              <p className="text-[10px] text-green-600 font-bold uppercase tracking-wider">Tu Ganancia</p>
              <p className="text-lg font-black text-green-600">+${selectedLoan.originalProfit.toLocaleString()}</p>
           </div>
        </div>
        {/* ------------------------------------------- */}

        <div className="grid grid-cols-2 gap-4 mb-8">
           <button onClick={() => setAction('payment')} className="bg-green-500 text-white p-5 rounded-3xl shadow-lg shadow-green-200 hover:bg-green-600 transition active:scale-95 flex flex-col items-center justify-center gap-2 group">
              <div className="p-3 bg-white/20 rounded-full group-hover:bg-white/30 transition"><DollarSign size={32} strokeWidth={3}/></div>
              <span className="font-bold text-lg">Abonar</span>
           </button>
           <button onClick={() => setAction('penalty')} className="bg-white border-2 border-red-50 text-red-500 p-5 rounded-3xl shadow-sm hover:border-red-100 transition active:scale-95 flex flex-col items-center justify-center gap-2">
              <div className="p-3 bg-red-50 rounded-full"><AlertCircle size={32}/></div>
              <span className="font-bold text-lg">Mora</span>
           </button>
        </div>

        {action && (
          <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in">
             <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-scale-up">
                <div className="flex justify-between items-center mb-6">
                   <h3 className="font-black text-xl text-gray-800">
                     {action === 'payment' ? 'Registrar Pago' : 'Aplicar Penalidad'}
                   </h3>
                   <button onClick={() => {setAction(null); setVal('')}} className="p-2 bg-gray-100 rounded-full text-gray-500 hover:bg-gray-200"><X size={20}/></button>
                </div>

                <form onSubmit={submitAction} className="space-y-4">
                   {action === 'payment' && (
                     <button 
                       type="button"
                       onClick={() => setVal(selectedLoan.balance)}
                       className="w-full py-3 bg-blue-50 text-blue-600 rounded-xl font-bold text-sm border border-blue-100 hover:bg-blue-100 flex justify-between px-4 items-center mb-2"
                     >
                        <span>Liquidar Deuda Total</span>
                        <span className="bg-white px-2 py-1 rounded text-blue-700">${selectedLoan.balance.toLocaleString()}</span>
                     </button>
                   )}

                   <div>
                     <label className="text-xs font-bold text-gray-400 uppercase tracking-wide ml-1">Monto a Ingresar</label>
                     <div className="relative mt-1">
                        <span className="absolute left-4 top-4 text-gray-400 text-xl font-bold">$</span>
                        <input type="number" autoFocus
                          className="w-full pl-10 pr-4 py-4 bg-gray-50 rounded-2xl text-3xl font-black text-gray-800 outline-none focus:ring-2 focus:ring-blue-500 transition"
                          placeholder="0.00" value={val} onChange={e => setVal(e.target.value)}
                        />
                     </div>
                   </div>

                   <input type="text" className="w-full p-4 bg-white border border-gray-200 rounded-2xl outline-none text-sm font-medium focus:border-blue-500"
                     placeholder="Nota opcional (Ej. Pago adelantado)" value={note} onChange={e => setNote(e.target.value)}/>

                   <button type="submit" className={`w-full py-4 rounded-2xl text-white font-bold text-lg shadow-xl active:scale-95 transition ${action === 'payment' ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600'}`}>
                     Confirmar {action === 'payment' ? 'Pago' : 'Cargo'}
                   </button>
                </form>
             </div>
          </div>
        )}

        <div className="space-y-4">
           <h3 className="font-bold text-gray-400 uppercase text-xs tracking-wider ml-1 border-b border-gray-200 pb-2 mb-4">Actividad Reciente</h3>
           {selectedLoan.history?.length === 0 && <p className="text-center text-gray-400 italic py-4">No hay movimientos aún</p>}
           {selectedLoan.history?.map((h, i) => (
             <div key={i} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-50 flex justify-between items-center">
                <div className="flex items-center gap-4">
                   <div className={`w-10 h-10 rounded-full flex items-center justify-center ${h.type === 'payment' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-500'}`}>
                      {h.type === 'payment' ? <DollarSign size={20}/> : <AlertCircle size={20}/>}
                   </div>
                   <div>
                      <p className="font-bold text-gray-700 leading-tight">{h.note}</p>
                      <p className="text-[10px] text-gray-400 font-medium">{h.date}</p>
                   </div>
                </div>
                <div className="text-right">
                   <p className={`font-black text-lg ${h.type === 'payment' ? 'text-green-600' : 'text-red-500'}`}>
                     {h.type === 'payment' ? '-' : '+'}${h.amount.toLocaleString()}
                   </p>
                   {h.type === 'payment' && (
                     <button onClick={() => setShowReceipt({loan: selectedLoan, transaction: h})} className="text-blue-500 text-[10px] font-bold uppercase tracking-wide bg-blue-50 px-2 py-1 rounded hover:bg-blue-100 transition">
                        Ver Recibo
                     </button>
                   )}
                </div>
             </div>
           ))}
        </div>
      </div>
    );
  };

  const NotificationToast = () => {
    if(!notification) return null;
    return (
      <div className="fixed top-4 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-2xl z-50 flex items-center gap-2 animate-slide-up">
        <CheckCircle size={18} className="text-green-400"/>
        <span className="font-bold text-sm">{notification}</span>
      </div>
    );
  }

  const PinModal = () => {
    if(!itemToDelete) return null;
    return (
      <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
         <div className="bg-white p-6 rounded-3xl w-full max-w-xs shadow-2xl animate-scale-up">
            <div className="text-center mb-6">
               <div className="bg-red-50 text-red-500 w-14 h-14 rounded-full flex items-center justify-center mx-auto mb-3"><Lock size={28}/></div>
               <h3 className="font-black text-gray-800 text-lg">Zona Segura</h3>
               <p className="text-xs text-gray-500 mt-1">Ingresa el PIN maestro para eliminar</p>
            </div>
            <input type="password" autoFocus className="w-full text-center text-3xl tracking-[0.3em] font-black border-2 border-gray-100 rounded-2xl p-3 mb-6 outline-none focus:border-red-500 transition-colors text-gray-700"
               placeholder="••••••" value={deletePinInput} onChange={e => setDeletePinInput(e.target.value)}/>
            <div className="flex gap-3">
               <button onClick={() => {setItemToDelete(null); setDeletePinInput('')}} className="flex-1 py-3 text-gray-500 font-bold hover:bg-gray-50 rounded-xl transition">Cancelar</button>
               <button onClick={verifyAndDelete} className="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold shadow-lg hover:bg-red-700 transition">Eliminar</button>
            </div>
         </div>
      </div>
    );
  };

  const Receipt = () => {
    if(!showReceipt) return null;
    const { loan, transaction } = showReceipt;
    return (
       <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4 backdrop-blur-sm">
          <div className="bg-white w-full max-w-sm rounded-2xl overflow-hidden shadow-2xl relative animate-scale-up">
             <button onClick={() => setShowReceipt(null)} className="absolute top-3 right-3 p-2 bg-white/20 hover:bg-white/40 rounded-full text-white z-10 transition"><X size={20}/></button>
             <div className="bg-blue-600 p-8 text-white text-center relative overflow-hidden">
                <div className="absolute -top-10 -left-10 w-32 h-32 bg-white opacity-10 rounded-full"></div>
                <div className="absolute top-10 right-10 w-16 h-16 bg-white opacity-10 rounded-full"></div>
                <h2 className="text-2xl font-black uppercase tracking-widest mb-1 relative z-10">Recibo</h2>
                <p className="text-xs opacity-80 font-medium relative z-10">{transaction.date}</p>
             </div>
             <div className="p-8">
                <div className="text-center mb-8">
                   <p className="text-gray-400 text-[10px] uppercase font-bold tracking-widest mb-2">Cliente</p>
                   <h3 className="text-2xl font-black text-gray-800">{loan.clientName}</h3>
                </div>
                <div className="bg-gray-50 border-2 border-dashed border-gray-200 p-5 rounded-xl mb-6">
                   <div className="flex justify-between mb-3">
                      <span className="text-gray-500 text-sm font-medium">Abono Recibido</span>
                      <span className="text-2xl font-black text-gray-800">${transaction.amount.toLocaleString()}</span>
                   </div>
                   <div className="w-full border-t border-gray-200 my-2"></div>
                   <div className="flex justify-between text-sm items-center">
                      <span className="text-gray-500 font-medium">Deuda Restante</span>
                      <span className="font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">${transaction.balanceAfter.toLocaleString()}</span>
                   </div>
                </div>
                <button onClick={() => window.print()} className="w-full py-4 bg-gray-900 text-white rounded-xl font-bold shadow-xl hover:bg-black transition flex justify-center items-center gap-2">
                   <Printer size={20}/> Imprimir Comprobante
                </button>
             </div>
          </div>
       </div>
    );
  };

  return (
    <div className="min-h-screen bg-gray-100 font-sans text-gray-900 pb-6">
      <div className="max-w-md mx-auto min-h-screen bg-white shadow-2xl relative">
        <div className="p-4 pt-6">
           {view === 'dashboard' && <Dashboard/>}
           {view === 'create' && <CreateLoan/>}
           {view === 'detail' && <LoanDetail/>}
        </div>
        <PinModal/>
        <Receipt/>
        <NotificationToast/>
      </div>
      <style>{`
        @media print { 
          body * { visibility: hidden; } 
          .fixed, .fixed * { visibility: visible; } 
          .fixed { position: absolute; inset: 0; background: white; z-index: 9999; }
          button { display: none !important; }
        }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .animate-scale-up { animation: scaleUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes scaleUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
      `}</style>
    </div>
  );
};

export default App;


