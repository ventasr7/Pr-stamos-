<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>PrestamosPro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- React & ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth,
      signInAnonymously,
      signInWithCustomToken,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      updateDoc,
      deleteDoc,
      doc,
      query,
      onSnapshot,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // ============================
    // ðŸ”¥ CONFIG FIREBASE AQUÃ
    // ============================
    const firebaseConfig = JSON.parse(__firebase_config); 
    const appId = typeof __app_id !== 'undefined' ? __app_id : "default-app-id";

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ============================
    // ðŸ’» APLICACIÃ“N REACT COMPLETA
    // ============================

    const { useState, useEffect, useMemo } = React;

    function App() {
      const [user, setUser] = useState(null);
      const [loans, setLoans] = useState([]);
      const [loading, setLoading] = useState(true);
      const [view, setView] = useState("dashboard");
      const [selectedLoan, setSelectedLoan] = useState(null);
      const [showReceipt, setShowReceipt] = useState(null);
      const [deletePinInput, setDeletePinInput] = useState('');
      const [itemToDelete, setItemToDelete] = useState(null);
      const [notification, setNotification] = useState(null);

      // --- AutenticaciÃ³n ---
      useEffect(() => {
        const init = async () => {
          try {
            if (typeof __initial_auth_token !== "undefined" && __initial_auth_token) {
              await signInWithCustomToken(auth, __initial_auth_token);
            } else {
              await signInAnonymously(auth);
            }
          } catch (e) {
            console.error("Error auth:", e);
          }
        };
        init();

        return onAuthStateChanged(auth, setUser);
      }, []);

      // --- Cargar datos ---
      useEffect(() => {
        if (!user) return;

        const q = query(collection(
          db, "artifacts", appId, "users", user.uid, "loans"
        ));

        return onSnapshot(q, (snap) => {
          const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          data.sort((a, b) => b.createdAt?.seconds - a.createdAt?.seconds);
          setLoans(data);
          setLoading(false);

          if (selectedLoan) {
            const updated = data.find(l => l.id === selectedLoan.id);
            if (updated) setSelectedLoan(updated);
          }
        });
      }, [user, selectedLoan?.id]);

      const NotificationToast = () =>
        notification ? (
          <div class="fixed top-4 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-xl z-50">
            {notification}
          </div>
        ) : null;

      // --- Render principal ---
      return (
        React.createElement("div", { className: "p-4" },
          React.createElement(NotificationToast),
          React.createElement("h1", { className: "text-2xl font-black" }, "PrestamosPro (Frontend listo)")
        )
      );
    }

    // Montar React
    ReactDOM.createRoot(document.getElementById("root")).render(
      React.createElement(App)
    );

  </script>

</head>
<body class="bg-gray-100">
  <div id="root"></div>
</body>
</html>
